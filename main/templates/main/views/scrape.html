{% extends 'main/parts/base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto p-8 flex gap-8">
    <!-- Left side - Process Flow -->
    <div class="w-2/3">
        <div id="process-flow" class="relative flex flex-col items-center">
            <!-- Vertical connector line -->
            <div class="absolute top-0 bottom-0 w-px bg-purple-200 left-1/2 -translate-x-1/2"></div>

            <!-- Process steps -->
            <div class="space-y-8 relative w-full max-w-md">

            </div>
        </div>
    </div>

    <!-- Right side - Process Creator -->
    <div class="w-1/3 bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <h2 class="text-lg font-semibold mb-4">Create New Process</h2>
        <form id="process-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Process Name</label>
                <input type="text" id="process-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-1 focus:ring-purple-500 focus:border-purple-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Icon Type</label>
                <select id="icon-type" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-1 focus:ring-purple-500 focus:border-purple-500">
                    <option value="settings">‚öôÔ∏è Settings</option>
                    <option value="code">üíª Code</option>
                    <option value="database">üóÑÔ∏è Database</option>
                    <option value="api">üîå API</option>
                </select>
            </div>
            <button type="submit" class="w-full bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
                Add Process
            </button>
        </form>
    </div>
</div>

<style>
    .step-container {
        position: relative;
        width: 100%;
        cursor: move;
    }

    .connector-dot {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 12px;
        height: 12px;
        background-color: #fff;
        border: 2px solid #E9D5FF;
        border-radius: 50%;
        z-index: 10;
    }

    .process-step {
        background: white;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        padding: 12px;
        margin: 0 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .process-step:hover {
        border-color: #C4B5FD;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .step-icon {
        width: 32px;
        height: 32px;
        background: #F3F4F6;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .step-content {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
    }

    .step-number {
        color: #6B7280;
        font-size: 0.75rem;
    }
</style>

<script>
        document.addEventListener('DOMContentLoaded', () => {
            const processFlow = document.getElementById('process-flow');
            const processForm = document.getElementById('process-form');
            const stepsContainer = processFlow.querySelector('.space-y-8');
            let draggedItem = null;

            // Initial steps
            const initialSteps = [
                { name: 'https://example.com', icon: 'url', isWebUrl: true },
                { name: 'Process Webhook Data', icon: 'code' },
                { name: 'Store Results in Database', icon: 'database' }
            ];

            initialSteps.forEach((step, index) => {
                const newStep = createProcessStep(step.name, step.icon, index + 1, step.isWebUrl);
                stepsContainer.appendChild(newStep);
            });

            // Drag and drop functionality
            stepsContainer.addEventListener('dragstart', (e) => {
                const stepContainer = e.target.closest('.step-container');
                if (stepContainer && !stepContainer.classList.contains('web-url-step')) {
                    draggedItem = stepContainer;
                    e.dataTransfer.effectAllowed = 'move';
                } else {
                    e.preventDefault();
                }
            });

            stepsContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                const target = e.target.closest('.step-container');
                if (target && target !== draggedItem && !target.classList.contains('web-url-step')) {
                    const targetRect = target.getBoundingClientRect();
                    const targetY = targetRect.top + targetRect.height / 2;
                    if (e.clientY < targetY) {
                        stepsContainer.insertBefore(draggedItem, target);
                    } else {
                        stepsContainer.insertBefore(draggedItem, target.nextSibling);
                    }
                    updateStepNumbers();
                }
            });

            // Add new process functionality
            processForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const processName = document.getElementById('process-name').value;
                const iconType = document.getElementById('icon-type').value;
                
                if (processName) {
                    const newStep = createProcessStep(processName, iconType, stepsContainer.children.length + 1);
                    stepsContainer.appendChild(newStep);
                    processForm.reset();
                    updateStepNumbers();
                }
            });

            function createProcessStep(name, iconType, number, isWebUrl = false) {
                const stepContainer = document.createElement('div');
                stepContainer.className = 'step-container';
                if (!isWebUrl) {
                    stepContainer.draggable = true;
                }

                const iconMap = {
                    settings: 'ri-settings-2-line text-purple-600',
                    code: 'ri-code-line text-orange-600',
                    database: 'ri-database-2-line text-blue-600',
                    api: 'ri-api-line text-green-600'
                };

                stepContainer.innerHTML = `
                    <div class="connector-dot"></div>
                    <div onclick="select_process(this)" class="process-step ${isWebUrl ? 'web-url-step' : ''}">
                        <div class="step-icon">
                            <i class="${iconMap[iconType]}"></i>
                        </div>
                        <div class="step-content">
                            <span class="step-number">${number}</span>
                            ${name}
                        </div>
                    </div>
                `;

                return stepContainer;
            }

            function updateStepNumbers() {
                const steps = stepsContainer.querySelectorAll('.step-container');
                steps.forEach((step, index) => {
                    const numberElement = step.querySelector('.step-number');
                    numberElement.textContent = index + 1;
                });

                console.log(stepsContainer)
            }
        });

        function select_process(this_){
            console.log(String(this_.textContent).trim())
        }
</script>

{% endblock %}